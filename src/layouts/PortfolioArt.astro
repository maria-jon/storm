---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import BaseLayout from './BaseLayout.astro';
import { SITE_DESCRIPTION, SITE_TITLE_TAG } from '../consts';
import CloseIcon from "../assets/icons/close.svg";

type Props = CollectionEntry<'portfolio'>['data'];

const { 
    title, 
    date, 
    cover, 
    coverAlt, 
    link, 
    linkText,
    tags,
    additionalImgs,
} = Astro.props;
---
<style>
    .portfolio-artwork {
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
        gap: var(--margin-md);
    }

    .hero-image {
        width: 100%;
        /*max-height: 126vh;*/
        background-color: var(--peachy-pink);
        padding: var(--margin-md);
        border-radius: var(--border-radius);
    }

    .hero-image img {
		width: 100%;
        height: 100%;
		object-fit: cover;
        border: 0.5em solid var(--wine-red);
        border-radius: var(--border-radius);
    }

    .prose, footer {
        background-color: var(--peachy-pink);
        padding: var(--margin-md);
        border-radius: var(--border-radius);
    }

    .artwork-title {
        font-size: clamp(2.5em, 8vw, 6em);
    }

    .artwork-info {
        display: flex;
        gap: var(--margin-md);
    }

    .additional-images {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        grid-template-rows: 1fr;
        gap: var(--margin-md);
    }

    @media (min-width: 600px) {
        .additional-images {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr;
        }
    }

    @media (min-width: 1024px) {
        .additional-images {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
        }
    }

    .additional-images img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--border-radius);
    }

    .img-card {
        padding: 0;
        border: 0;
        background: transparent;
        cursor: zoom-in;
    }

    .lightbox {
        border: none;
        padding: 0;
        background: transparent;
        max-width: min(92vw, 1100px);
        max-height: 92vh;
    }

    .lightbox::backdrop {
        background: rgba(0, 0, 0, 0.75);
    }

    .lightbox-img {
        width: 100%;
        height: auto;
        max-height: 92vh;
        object-fit: contain;
        display: block;
        border-radius: var(--border-radius);
        background: var(--black);
    }

    .lightbox-close {
        position: absolute;
        top: 0;
        right: 0;
        border: 0;
        border-radius: var(--border-radius);
        margin: 0.5rem 0.5rem;
        cursor: pointer;
        background: var(--peachy-pink);
        opacity: 0.75;
        display: flex;
        justify-content: center;
        padding-block: 0.375em;
        padding-inline: 0.375em;
    }

    .lightbox-close:hover {
        opacity: 1;
    }

</style>

<BaseLayout 
    title={`${title} ${SITE_TITLE_TAG}`}
    description={SITE_DESCRIPTION} 
    background="wine-red"
>
    <article class="portfolio-artwork">
        <!-- 
        <div class="hero-image">
            {cover && <Image width={940} height={1268} src={cover} alt={coverAlt} />}
        </div>
        -->
        <div class="prose">
            <h1 class="artwork-title">
                {title}
            </h1>
            <slot />
            <div class="artwork-info">
                <div class="date">
                    <FormattedDate date={date} />
                </div>
                {
                    link && <a href={link}
                    >
                        Link {linkText && <span>to {linkText}</span>}
                    </a>
                }
            </div>
        </div>

        <footer>
            {
                additionalImgs && <div class="additional-images">
                    {cover && (
                        <button
                            type="button"
                            class="img-card"
                            data-fullsrc={cover}
                            aria-label="Open image in larger view"
                        >
                            <Image width={940} height={1268} src={cover} alt={coverAlt} />
                        </button>
                    )}
                    {
                        additionalImgs.map((img) => (
                            <button
                                type="button"
                                class="img-card"
                                data-fullsrc={img}
                                aria-label="Open image in larger view"
                            >
                                <img 
                                    width={940} 
                                    height={1268} 
                                    src={img} 
                                    alt=""
                                />
                            </button>
                        ))
                    }
                </div>
            }
        </footer>
        <dialog class="lightbox" id="lightbox">
            <button class="lightbox-close" type="button" aria-label="Close">
                <CloseIcon
                    width={32}
                    height={32}
                    aria-label="Toggle menu"
                    class="close-icon hidden"
                />
            </button>
            <img class="lightbox-img" alt="" />
        </dialog>

        <script is:inline>
            const dialog = document.getElementById('lightbox');
            const imgEl = dialog?.querySelector('.lightbox-img');
            const closeBtn = dialog?.querySelector('.lightbox-close');

            function openLightbox(src) {
                if (!dialog || !imgEl) return;
                imgEl.src = src;
                dialog.showModal();
            }

            function closeLightbox() {
                dialog?.close();
                if (imgEl) imgEl.src = '';
            }

            // Open on click
            document.addEventListener('click', (e) => {
                const btn = e.target.closest?.('.img-card[data-fullsrc]');
                if (!btn) return;
                openLightbox(btn.dataset.fullsrc);
            });

            // Close button
            closeBtn?.addEventListener('click', closeLightbox);

            // Click backdrop to close
            dialog?.addEventListener('click', (e) => {
                if (e.target === dialog) closeLightbox();
            });

            // Clear src on close
            dialog?.addEventListener('close', () => {
                if (imgEl) imgEl.src = '';
            });
        </script>
    </article>
</BaseLayout>
